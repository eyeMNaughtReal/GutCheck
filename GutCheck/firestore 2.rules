rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // GLOBAL RULES & HELPER FUNCTIONS
    // ============================================================================
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is accessing data they created
    function isCreator(createdBy) {
      return isAuthenticated() && request.auth.uid == createdBy;
    }
    
    // Helper function to check if data is public (non-sensitive)
    function isPublicData(data) {
      return data.privacyLevel == 'public' || !('privacyLevel' in data);
    }
    
    // Helper function to check if user has accepted privacy policy
    function hasAcceptedPrivacyPolicy(data) {
      return data.privacyPolicyAccepted == true && 
             ('privacyPolicyVersion' in data) &&
             data.privacyPolicyVersion != null;
    }
    
    // Helper function to validate required fields
    function hasRequiredFields(data, requiredFields) {
      return requiredFields.hasAll(data.keys());
    }
    
    // Helper function to check if user is admin
    function isAdmin(userId) {
      // Check against admin user IDs - replace with your actual admin IDs
      return userId == 'admin' || userId == 'markconley';
    }
    
    // Helper function to validate timestamp fields
    function hasValidTimestamps(data, isUpdate) {
      return isUpdate ? 
        ('updatedAt' in data) : 
        ('createdAt' in data && 'updatedAt' in data);
    }
    
    // ============================================================================
    // USER PROFILES & AUTHENTICATION
    // ============================================================================
    
    match /users/{userId} {
      // Users can only read/write their own profile
      allow read: if isOwner(userId);
      
      // Validate user profile data structure including privacy policy
      allow create: if isOwner(userId) && 
        request.resource.data.keys().hasAny(['email', 'firstName', 'lastName', 'signInMethod', 'createdAt', 'updatedAt', 'privacyPolicyAccepted', 'privacyPolicyVersion']) &&
        hasAcceptedPrivacyPolicy(request.resource.data);
      
      allow update: if isOwner(userId) && 
        hasAcceptedPrivacyPolicy(request.resource.data);
      
      allow delete: if isOwner(userId);
      
      // ============================================================================
      // USER SUBCOLLECTIONS
      // ============================================================================
      
      // Meals subcollection for user
      match /meals/{mealId} {
        allow read: if isOwner(userId);
        
        allow create: if isOwner(userId) &&
          'date' in request.resource.data &&
          'type' in request.resource.data &&
          'source' in request.resource.data;
        
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
        
        // Food items within user's meals
        match /foodItems/{foodItemId} {
          allow read, write: if isOwner(userId);
        }
      }
      
      // Symptoms subcollection for user
      match /symptoms/{symptomId} {
        allow read: if isOwner(userId);
        
        allow create: if isOwner(userId) &&
          'date' in request.resource.data &&
          'stoolType' in request.resource.data;
        
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      // Activities subcollection for user
      match /activities/{activityId} {
        allow read: if isOwner(userId);
        
        allow create: if isOwner(userId) &&
          'date' in request.resource.data &&
          'type' in request.resource.data;
        
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      // Reminders subcollection for user
      match /reminders/{reminderId} {
        allow read, write: if isOwner(userId);
      }
      
      // Meal history within users
      match /mealHistory/{mealId} {
        allow read, write: if isOwner(userId);
      }
      
      // Symptom history within users
      match /symptomHistory/{symptomId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================================================
    // GLOBAL MEAL DATA SECURITY (for cross-user queries)
    // ============================================================================

    match /meals/{mealId} {
      // Allow authenticated users to read meals by document ID
      allow get: if isAuthenticated() && 
                 resource.data.userId == request.auth.uid;
      
      // Allow authenticated users to list their own meals
      allow list: if isAuthenticated();
      
      // Users can create meals (must include userId field matching auth)
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        'userId' in request.resource.data &&
        'date' in request.resource.data &&
        'type' in request.resource.data &&
        'source' in request.resource.data;
      
      // Users can update their own meals
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId;
      
      // Users can delete their own meals
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
      
      // Food items within meals (global collection)
      match /foodItems/{foodItemId} {
        allow read, write: if isAuthenticated() && 
          exists(/databases/$(database)/documents/meals/$(mealId)) &&
          get(/databases/$(database)/documents/meals/$(mealId)).data.userId == request.auth.uid;
      }
    }
    
    // ============================================================================
    // GLOBAL SYMPTOM DATA SECURITY (for cross-user queries)
    // ============================================================================
    
    match /symptoms/{symptomId} {
      // Allow authenticated users to read their symptoms by document ID
      allow get: if isAuthenticated() &&
                 resource.data.userId == request.auth.uid;
      
      // Allow authenticated users to list their symptoms
      allow list: if isAuthenticated();
      
      // Users can create symptoms (must include userId field matching auth)
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        'date' in request.resource.data &&
        'stoolType' in request.resource.data &&
        'userId' in request.resource.data;
      
      // Users can update their own symptoms
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId;
      
      // Users can delete their own symptoms
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // GLOBAL ACTIVITIES DATA SECURITY
    // ============================================================================
    
    match /activities/{activityId} {
      // Allow authenticated users to read their activities
      allow get: if isAuthenticated() &&
                 resource.data.userId == request.auth.uid;
      
      allow list: if isAuthenticated();
      
      // Users can create activities
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        'userId' in request.resource.data &&
        'date' in request.resource.data &&
        'type' in request.resource.data;
      
      // Users can update their own activities
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId;
      
      // Users can delete their own activities
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // MEAL TEMPLATES SECURITY
    // ============================================================================
    
    match /mealTemplates/{templateId} {
      // Users can read their own templates
      allow read: if isAuthenticated() && 
                  resource.data.userId == request.auth.uid;
      
      // Users can read public templates (for community sharing)
      allow read: if isAuthenticated() && isPublicData(resource.data);
      
      // Users can create templates (must include userId field)
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        'name' in request.resource.data &&
        'foodItems' in request.resource.data &&
        'userId' in request.resource.data;
      
      // Users can update their own templates
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.auth.uid == request.resource.data.userId;
      
      // Users can delete their own templates
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // INSIGHTS & PATTERNS SECURITY
    // ============================================================================
    
    match /insights/{insightId} {
      // Users can read their own insights
      allow read: if isAuthenticated() &&
                  resource.data.userId == request.auth.uid;
      
      // Users can read public insights (for community learning)
      allow read: if isAuthenticated() && isPublicData(resource.data);
      
      // Users can create insights (must include userId field)
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        'type' in request.resource.data &&
        'title' in request.resource.data &&
        'description' in request.resource.data &&
        'userId' in request.resource.data;
      
      // Users can update their own insights
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.auth.uid == request.resource.data.userId;
      
      // Users can delete their own insights
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // REMINDER SETTINGS SECURITY
    // ============================================================================
    
    match /reminderSettings/{userId} {
      // Users can only access their own reminder settings
      allow read, write: if isOwner(userId);
      
      // Validate reminder settings data structure
      allow create: if isOwner(userId) && 
        'userId' in request.resource.data &&
        'enabled' in request.resource.data;
      
      allow update: if isOwner(userId);
    }
    
    // ============================================================================
    // REMINDERS COLLECTION (Global reminders)
    // ============================================================================
    
    match /reminders/{reminderId} {
      // Users can read their own reminders
      allow read: if isAuthenticated() &&
                  resource.data.userId == request.auth.uid;
      
      allow list: if isAuthenticated();
      
      // Users can create reminders
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        'userId' in request.resource.data;
      
      // Users can update their own reminders
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId;
      
      // Users can delete their own reminders
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // USER PREFERENCES & SETTINGS SECURITY
    // ============================================================================
    
    match /userPreferences/{userId} {
      // Users can only access their own preferences
      allow read, write: if isOwner(userId);
      
      // Validate preferences data structure
      allow create: if isOwner(userId) && 
        'userId' in request.resource.data;
      
      allow update: if isOwner(userId);
    }
    
    // ============================================================================
    // ANALYTICS & USAGE DATA SECURITY
    // ============================================================================
    
    match /analytics/{userId} {
      // Users can only access their own analytics
      allow read, write: if isOwner(userId);
      
      // Validate analytics data structure
      allow create: if isOwner(userId) && 
        'userId' in request.resource.data;
      
      allow update: if isOwner(userId);
    }
    
    // ============================================================================
    // TEST COLLECTION (for development/testing)
    // ============================================================================
    
    match /test/{documentId} {
      // Allow authenticated users to test connection
      allow read: if isAuthenticated();
      
      // Only allow writes for admins or in development
      allow write: if isAdmin(request.auth.uid);
    }
    
    // ============================================================================
    // PUBLIC DATA COLLECTIONS (READ-ONLY FOR ALL AUTHENTICATED USERS)
    // ============================================================================
    
    // Public food database (read-only for all authenticated users)
    match /publicFoods/{foodId} {
      allow read: if isAuthenticated();
      // Only admins can write to public food database
      allow write: if isAdmin(request.auth.uid);
    }
    
    // Public nutrition database (read-only for all authenticated users)
    match /publicNutrition/{nutritionId} {
      allow read: if isAuthenticated();
      // Only admins can write to public nutrition database
      allow write: if isAdmin(request.auth.uid);
    }
    
    // ============================================================================
    // ADMIN-ONLY COLLECTIONS
    // ============================================================================
    
    // System configuration (admin only)
    match /systemConfig/{configId} {
      allow read, write: if isAdmin(request.auth.uid);
    }
    
    // App analytics (admin only)
    match /appAnalytics/{analyticsId} {
      allow read, write: if isAdmin(request.auth.uid);
    }
    
    // ============================================================================
    // DATA DELETION REQUESTS SECURITY
    // ============================================================================
    
    match /dataDeletionRequests/{requestId} {
      // Users can read their own deletion requests
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         isAdmin(request.auth.uid));
      
      // Allow listing for users to see their own requests
      allow list: if isAuthenticated();
      
      // Users can create deletion requests for themselves
      allow create: if isAuthenticated() &&
        request.auth.uid == request.resource.data.userId &&
        'userId' in request.resource.data &&
        'userEmail' in request.resource.data &&
        'userName' in request.resource.data &&
        'requestDate' in request.resource.data &&
        'status' in request.resource.data &&
        request.resource.data.status == 'pending';
      
      // Only admins can update deletion request status
      allow update: if isAuthenticated() && isAdmin(request.auth.uid);
      
      // Only admins can delete deletion requests
      allow delete: if isAuthenticated() && isAdmin(request.auth.uid);
    }
    
    // ============================================================================
    // ENCRYPTED PRIVATE DATA SECURITY (End-to-End Encrypted Backups)
    // ============================================================================
    
    match /encryptedPrivateData/{documentId} {
      // Users can read their own encrypted data by document ID
      allow get: if isAuthenticated() && 
                 resource.data.userId == request.auth.uid;
      
      // Users can query/list their own encrypted data
      allow list: if isAuthenticated();
      
      // Users can create new encrypted data
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid &&
                    'userId' in request.resource.data &&
                    'dataType' in request.resource.data &&
                    'encryptedData' in request.resource.data &&
                    'createdAt' in request.resource.data &&
                    request.resource.data.encryptedData is string;
      
      // Users can update their own encrypted data  
      allow update: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid &&
                    request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own encrypted data
      allow delete: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
    }
  }
}
