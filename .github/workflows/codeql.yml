name: CodeQL

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run every Monday at 08:00 UTC for ongoing security coverage
    - cron: '0 8 * * 1'

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    # Swift requires macOS; all other languages run on ubuntu for speed
    runs-on: ${{ matrix.language == 'swift' && 'macos-15' || 'ubuntu-latest' }}

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          # Primary language — Swift/iOS app
          - language: swift
            build-mode: manual
          # GitHub Actions workflow files
          - language: actions
            build-mode: none

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      # ── Swift-only setup ────────────────────────────────────────────────────
      - name: Set up Xcode
        if: matrix.language == 'swift'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Create mock GoogleService-Info.plist
        if: matrix.language == 'swift'
        run: |
          cat > GoogleService-Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CLIENT_ID</key>
            <string>123456789012-abcdefghijklmnopqrstuvwxyz123456.apps.googleusercontent.com</string>
            <key>REVERSED_CLIENT_ID</key>
            <string>com.googleusercontent.apps.123456789012-abcdefghijklmnopqrstuvwxyz123456</string>
            <key>API_KEY</key>
            <string>MOCK-API-KEY-NOT-REAL-DO-NOT-USE</string>
            <key>GCM_SENDER_ID</key>
            <string>123456789012</string>
            <key>PLIST_VERSION</key>
            <string>1</string>
            <key>BUNDLE_ID</key>
            <string>com.MarkConley.GutCheck</string>
            <key>PROJECT_ID</key>
            <string>mock-gutcheck-ci</string>
            <key>STORAGE_BUCKET</key>
            <string>mock-gutcheck-ci.appspot.com</string>
            <key>IS_ADS_ENABLED</key>
            <false/>
            <key>IS_ANALYTICS_ENABLED</key>
            <false/>
            <key>IS_APPINVITE_ENABLED</key>
            <true/>
            <key>IS_GCM_ENABLED</key>
            <true/>
            <key>IS_SIGNIN_ENABLED</key>
            <true/>
            <key>GOOGLE_APP_ID</key>
            <string>1:123456789012:ios:abcdef1234567890abcdef</string>
          </dict>
          </plist>
          EOF
        working-directory: GutCheck/GutCheck

      - name: Prepare iOS Simulator
        if: matrix.language == 'swift'
        working-directory: GutCheck
        run: |
          xcrun simctl list runtimes
          IOS_RUNTIME=$(xcrun simctl list runtimes 2>&1 | \
            grep -E "^iOS [0-9]" | grep -v "unavailable" | head -1)
          if [ -z "$IOS_RUNTIME" ]; then
            echo "No installed iOS runtime — downloading iOS platform"
            xcodebuild -downloadPlatform iOS
            xcrun simctl list runtimes
          fi
          UDID=$(xcodebuild -showdestinations \
            -project GutCheck.xcodeproj \
            -scheme GutCheck 2>&1 | \
            grep "platform:iOS Simulator" | \
            grep -i "name:iPhone" | \
            tail -1 | \
            grep -oE 'id:[0-9A-Fa-f-]+' | \
            sed 's/id://')
          if [ -z "$UDID" ]; then
            UDID=$(xcrun simctl list devices available | \
              grep -E "^ +iPhone" | tail -1 | \
              grep -oE '[0-9A-Fa-f]{8}-([0-9A-Fa-f]{4}-){3}[0-9A-Fa-f]{12}')
          fi
          xcrun simctl boot "$UDID" 2>/dev/null || true
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "Using simulator UDID: $UDID"

      # ── CodeQL core steps ───────────────────────────────────────────────────
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}

      - name: Build Swift project for CodeQL
        if: matrix.language == 'swift'
        working-directory: GutCheck
        run: |
          xcodebuild build \
            -project GutCheck.xcodeproj \
            -scheme GutCheck \
            -destination "id=${{ env.SIMULATOR_UDID }}" \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
