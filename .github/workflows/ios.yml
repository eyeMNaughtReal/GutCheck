name: iOS Build & Test

permissions:
  contents: read
  actions: write

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-15

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/org.swift.swiftpm/
          GutCheck/.build
        key: ${{ runner.os }}-spm-${{ hashFiles('GutCheck/GutCheck.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-deriveddata-${{ hashFiles('GutCheck/GutCheck.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-deriveddata-

    - name: Create GoogleService-Info.plist (Mock)
      run: |
        cat > GoogleService-Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>CLIENT_ID</key>
          <string>123456789012-abcdefghijklmnopqrstuvwxyz123456.apps.googleusercontent.com</string>
          <key>REVERSED_CLIENT_ID</key>
          <string>com.googleusercontent.apps.123456789012-abcdefghijklmnopqrstuvwxyz123456</string>
          <key>API_KEY</key>
          <string>AIzaSyA00000000000000000000000000000000</string>
          <key>GCM_SENDER_ID</key>
          <string>123456789012</string>
          <key>PLIST_VERSION</key>
          <string>1</string>
          <key>BUNDLE_ID</key>
          <string>com.MarkConley.GutCheck</string>
          <key>PROJECT_ID</key>
          <string>mock-gutcheck-ci</string>
          <key>STORAGE_BUCKET</key>
          <string>mock-gutcheck-ci.appspot.com</string>
          <key>IS_ADS_ENABLED</key>
          <false/>
          <key>IS_ANALYTICS_ENABLED</key>
          <false/>
          <key>IS_APPINVITE_ENABLED</key>
          <true/>
          <key>IS_GCM_ENABLED</key>
          <true/>
          <key>IS_SIGNIN_ENABLED</key>
          <true/>
          <key>GOOGLE_APP_ID</key>
          <string>1:123456789012:ios:abcdef1234567890abcdef</string>
        </dict>
        </plist>
        EOF
      working-directory: GutCheck/GutCheck

    - name: Resolve Swift Package Dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -project GutCheck.xcodeproj \
          -scheme GutCheck
      working-directory: GutCheck

    - name: Prepare iOS Simulator
      working-directory: GutCheck
      run: |
        # Step 1: Initialise CoreSimulator under the active Xcode 16.2 toolchain
        xcrun simctl list runtimes

        # Step 2: Check whether an iOS Simulator runtime is ACTUALLY installed.
        # simctl device records can exist in the database even when the runtime
        # files themselves are missing, causing a false-positive UDID match.
        IOS_RUNTIME=$(xcrun simctl list runtimes 2>&1 | \
          grep -E "^iOS [0-9]" | grep -v "unavailable" | head -1)

        if [ -z "$IOS_RUNTIME" ]; then
          echo "No installed iOS Simulator runtime found â€” downloading iOS platform (may take several minutes)"
          xcodebuild -downloadPlatform iOS
          xcrun simctl list runtimes
        fi

        # Step 3: Ask xcodebuild itself which destinations it can use.
        # This is more reliable than xcrun simctl, which can list device UDIDs
        # even when the corresponding runtime files are not installed.
        UDID=$(xcodebuild -showdestinations \
          -project GutCheck.xcodeproj \
          -scheme GutCheck 2>&1 | \
          grep "platform:iOS Simulator" | \
          grep -i "name:iPhone" | \
          tail -1 | \
          grep -oE 'id:[0-9A-Fa-f-]+' | \
          sed 's/id://')

        # Step 4: Fall back to simctl only if xcodebuild found nothing
        if [ -z "$UDID" ]; then
          UDID=$(xcrun simctl list devices available | \
            grep -E "^ +iPhone" | \
            tail -1 | \
            grep -oE '[0-9A-Fa-f]{8}-([0-9A-Fa-f]{4}-){3}[0-9A-Fa-f]{12}')
        fi

        # Step 5: Fail loudly with full diagnostics if still no simulator found
        if [ -z "$UDID" ]; then
          echo "ERROR: No iPhone simulator found even after runtime download" >&2
          xcrun simctl list runtimes
          xcrun simctl list devices available
          exit 1
        fi

        # Step 6: Boot the simulator so xcodebuild can attach to it immediately
        xcrun simctl boot "$UDID" 2>/dev/null || true

        echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
        echo "Using simulator UDID: $UDID"

    - name: Build GutCheck
      run: |
        xcodebuild clean build \
          -project GutCheck.xcodeproj \
          -scheme GutCheck \
          -destination "id=${{ env.SIMULATOR_UDID }}" \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO
      working-directory: GutCheck

    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -project GutCheck.xcodeproj \
          -scheme GutCheck \
          -destination "id=${{ env.SIMULATOR_UDID }}" \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO \
          -skip-testing:GutCheckUITests \
          -enableCodeCoverage YES \
          -resultBundlePath ~/Library/Developer/Xcode/DerivedData/Build/Logs/Test/results.xcresult
      working-directory: GutCheck

    - name: Generate Code Coverage Report
      run: |
        xcrun xccov view --report --json ~/Library/Developer/Xcode/DerivedData/Build/Logs/Test/results.xcresult > coverage.json
        xcrun xccov view --report ~/Library/Developer/Xcode/DerivedData/Build/Logs/Test/results.xcresult
      working-directory: GutCheck
      continue-on-error: true

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: GutCheck/coverage.json
        flags: ios
        name: ios-coverage
      continue-on-error: true

    - name: Upload Build Artifacts on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/Library/Developer/Xcode/DerivedData/Build/Logs/
          GutCheck/coverage.json
        retention-days: 5
